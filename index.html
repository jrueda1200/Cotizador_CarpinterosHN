<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Cotizador en Línea</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- jsPDF y AutoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root {
      --primary: #2563eb;
      --primary-soft: #eff6ff;
      --bg: #020617;
      --card: #ffffff;
      --border: #e5e7eb;
      --text-main: #111827;
      --text-muted: #6b7280;
      --danger: #dc2626;
      --radius-lg: 18px;
      --radius-sm: 10px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      background:
        radial-gradient(circle at top, #1d4ed8 0, rgba(15,23,42,0.3) 35%),
        radial-gradient(circle at bottom, #0ea5e9 0, #020617 55%);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: var(--text-main);
      display: flex;
      justify-content: center;
      padding: 16px;
    }

    .shell {
      max-width: 980px;
      width: 100%;
    }

    .app-header {
      color: #e5e7eb;
      text-align: center;
      margin-bottom: 14px;
    }

    .app-header h1 {
      margin: 0 0 4px;
      font-size: 1.7rem;
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }

    .app-header p {
      margin: 0;
      font-size: 0.85rem;
      color: #9ca3af;
    }

    .card {
      background: var(--card);
      border-radius: var(--radius-lg);
      padding: 18px 16px 20px;
      box-shadow:
        0 20px 55px rgba(15, 23, 42, 0.55),
        0 0 0 1px rgba(15, 23, 42, 0.12);
    }

    @media (min-width: 768px) {
      .card {
        padding: 22px 24px 24px;
      }
    }

    .section-title {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.9rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .section-title::before {
      content: "";
      width: 4px;
      height: 18px;
      border-radius: 999px;
      background: linear-gradient(180deg, var(--primary), #4f46e5);
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 10px;
    }

    .field {
      flex: 1;
      min-width: 180px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    label {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-muted);
    }

    input,
    textarea {
      padding: 9px 11px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      font-size: 0.9rem;
      outline: none;
      transition: border-color 0.15s, box-shadow 0.15s, background-color 0.15s;
      background-color: #f9fafb;
    }

    input:focus,
    textarea:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.5);
      background-color: #ffffff;
    }

    textarea {
      resize: vertical;
      min-height: 70px;
    }

    /* Tabla de ítems */
    .table-wrapper {
      margin-top: 6px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      overflow: hidden;
      background: #f9fafb;
    }

    .table-scroll {
      width: 100%;
      overflow-x: auto;
    }

    .table-hint {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 4px;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .table-hint span {
      font-size: 0.9rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 650px;
      font-size: 0.86rem;
      background: #ffffff;
    }

    thead {
      background: #f3f4f6;
    }

    th,
    td {
      padding: 7px 8px;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
      white-space: nowrap;
    }

    th {
      font-weight: 600;
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
    }

    tbody tr:last-child td {
      border-bottom: none;
    }

    td input {
      border-radius: 6px;
      border: 1px solid transparent;
      padding: 5px 6px;
      font-size: 0.86rem;
      width: 100%;
      background: transparent;
    }

    td input:focus {
      background: #eff6ff;
      border-color: #bfdbfe;
      outline: none;
    }

    td input[readonly] {
      background: #f9fafb;
      border-color: transparent;
      font-weight: 600;
    }

    .btn-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 10px;
      flex-wrap: wrap;
      gap: 8px;
    }

    button {
      border-radius: 999px;
      border: none;
      padding: 9px 16px;
      font-size: 0.86rem;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: transform 0.08s ease, box-shadow 0.12s ease, background 0.12s ease;
      white-space: nowrap;
    }

    button:active {
      transform: translateY(1px);
      box-shadow: none;
    }

    .btn-secondary {
      background: #e5e7eb;
      color: #111827;
    }

    .btn-secondary:hover {
      background: #d1d5db;
    }

    .btn-primary {
      background: var(--primary);
      color: #ffffff;
      box-shadow: 0 10px 22px rgba(37, 99, 235, 0.4);
    }

    .btn-primary:hover {
      background: #1d4ed8;
    }

    .btn-danger {
      background: var(--danger);
      color: #ffffff;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 0.75rem;
      box-shadow: none;
    }

    .btn-danger:hover {
      background: #b91c1c;
    }

    .btn-icon {
      font-size: 1rem;
      line-height: 0;
    }

    .totals-card {
      margin-top: 18px;
      padding: 12px;
      border-radius: 14px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
    }

    .totals {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
      margin-top: 6px;
    }

    @media (min-width: 720px) {
      .totals {
        grid-template-columns: repeat(4, minmax(0, 1fr));
      }
    }

    .field input[readonly] {
      background: #eef2ff;
      font-weight: 600;
    }

    .pill {
      padding: 3px 9px;
      border-radius: 999px;
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      background: var(--primary-soft);
      color: var(--primary);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .conditions {
      margin-top: 16px;
    }

    .footer-actions {
      margin-top: 18px;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      flex-wrap: wrap;
    }

    .hint {
      font-size: 0.76rem;
      color: var(--text-muted);
    }

    .footer-note {
      margin-top: 10px;
      font-size: 0.72rem;
      color: #9ca3af;
      text-align: right;
    }

    /* Mobile tweaks */
    @media (max-width: 600px) {
      body {
        padding: 10px;
      }
      .card {
        border-radius: 16px;
        padding: 16px 12px 18px;
      }
      .app-header h1 {
        font-size: 1.4rem;
      }
      .app-header p {
        font-size: 0.8rem;
      }
      .btn-row {
        flex-direction: column;
        align-items: stretch;
      }
      .btn-row > * {
        width: 100%;
        justify-content: center;
      }
      .footer-actions {
        justify-content: center;
      }
      button {
        width: 100%;
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <div class="shell">
    <header class="app-header">
      <h1>COTIZADOR EN LÍNEA</h1>
      <p>Genera y descarga cotizaciones en PDF desde cualquier dispositivo.</p>
    </header>

    <main class="card">
      <!-- DATOS GENERALES -->
      <div class="section-title">Datos generales</div>
      <div class="row">
        <div class="field">
          <label for="fecha">Fecha</label>
          <input type="date" id="fecha" />
        </div>
        <div class="field">
          <label for="cliente">A nombre de</label>
          <input type="text" id="cliente" placeholder="Nombre del cliente o empresa" />
        </div>
      </div>

      <div class="field">
        <label for="descripcion">Descripción del trabajo</label>
        <textarea id="descripcion" placeholder="Ej.: Elaboración y enreglado de ceiling con madera de Laurel entintado color roble claro."></textarea>
      </div>

      <!-- ITEMS -->
      <div style="margin-top: 18px;">
        <div class="section-title">
          Ítems de la cotización
          <span class="pill">
            <span>＋</span> Materiales y servicios
          </span>
        </div>

        <div class="table-wrapper">
          <div class="table-scroll">
            <table>
              <thead>
                <tr>
                  <th style="width: 40%;">Ítem / detalle</th>
                  <th style="width: 15%;">Cantidad</th>
                  <th style="width: 20%;">Precio unitario (L.)</th>
                  <th style="width: 20%;">Total ítem (L.)</th>
                  <th style="width: 5%; text-align:center;"> </th>
                </tr>
              </thead>
              <tbody id="items-body">
                <!-- Fila inicial -->
                <tr>
                  <td><input type="text" class="item-detalle" placeholder="Ej.: Madera Laurel" /></td>
                  <td><input type="number" step="0.01" class="item-cantidad" placeholder="0" /></td>
                  <td><input type="number" step="0.01" class="item-precio" placeholder="0.00" /></td>
                  <td><input type="number" step="0.01" class="item-total" readonly /></td>
                  <td style="text-align:center;"><button type="button" class="btn-danger btn-delete-row" title="Eliminar fila">X</button></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        <div class="table-hint">
          <span>⟷</span> Desliza horizontalmente la tabla si no ves todas las columnas en tu pantalla.
        </div>

        <div class="btn-row">
          <button type="button" class="btn-secondary" id="add-row">
            <span class="btn-icon">＋</span>
            Agregar ítem
          </button>
          <span class="hint">Completa los materiales y servicios. El total por ítem y los totales se calculan automáticamente.</span>
        </div>
      </div>

      <!-- TOTALES -->
      <div class="totals-card">
        <div class="section-title" style="margin-bottom: 4px;">Totales</div>
        <div class="totals">
          <div class="field">
            <label for="subtotal">Subtotal (L.)</label>
            <input type="number" id="subtotal" readonly />
          </div>
          <div class="field">
            <label for="impuestoPorc">Impuesto (%)</label>
            <input type="number" id="impuestoPorc" step="0.01" value="15" />
          </div>
          <div class="field">
            <label for="impuesto">Impuesto (L.)</label>
            <input type="number" id="impuesto" readonly />
          </div>
          <div class="field">
            <label for="total">Total (L.)</label>
            <input type="number" id="total" readonly />
          </div>
        </div>
      </div>

      <!-- CONDICIONES -->
      <div class="conditions">
        <div class="section-title">Condiciones y observaciones</div>
        <textarea id="condiciones" style="min-height: 80px;"></textarea>
        <div class="hint" style="margin-top: 4px;">
          Personaliza estos textos según el tipo de trabajo, forma de pago o vigencia de la oferta.
        </div>
      </div>

      <!-- ACCIONES -->
      <div class="footer-actions">
        <button type="button" class="btn-secondary" id="reset-form">Limpiar formulario</button>
        <button type="button" class="btn-primary" id="download-pdf">
          <span class="btn-icon">⬇</span>
          Descargar PDF profesional
        </button>
      </div>

      <div class="footer-note">
        Generado con el cotizador en línea.
      </div>
    </main>
  </div>

  <script>
    // ============= CONFIGURACIÓN DE EMPRESA PARA EL PDF =============
    const COMPANY_NAME = "Carpinteros HN";
    const COMPANY_ADDRESS = "Servicios en Linea";
    const COMPANY_PHONE = "Tel: [+504 95292507]";
    const COMPANY_EMAIL = "Correo: []";
    // Si tienes un logo en línea, pon la URL aquí (deja null si no):
    const COMPANY_LOGO_URL = null; // Ej.: "https://tusitio.com/logo.png"

    // ================= FUNCIONES DE CÁLCULO =================
    function toNumber(value) {
      if (typeof value !== "string") value = String(value || "");
      value = value.replace(",", ".");
      const n = parseFloat(value);
      return isNaN(n) ? 0 : n;
    }

    function recalcRowTotals() {
      const tbody = document.getElementById("items-body");
      const rows = Array.from(tbody.querySelectorAll("tr"));
      let subtotal = 0;

      rows.forEach(row => {
        const cantidadInput = row.querySelector(".item-cantidad");
        const precioInput = row.querySelector(".item-precio");
        const totalInput = row.querySelector(".item-total");

        const cantidad = toNumber(cantidadInput.value);
        const precio = toNumber(precioInput.value);
        const total = cantidad * precio;

        totalInput.value = total ? total.toFixed(2) : "";
        subtotal += total;
      });

      const subtotalInput = document.getElementById("subtotal");
      subtotalInput.value = subtotal.toFixed(2);

      const impuestoPorc = toNumber(document.getElementById("impuestoPorc").value);
      const impuesto = subtotal * (impuestoPorc / 100);
      document.getElementById("impuesto").value = impuesto.toFixed(2);
      document.getElementById("total").value = (subtotal + impuesto).toFixed(2);
    }

    function addRow() {
      const tbody = document.getElementById("items-body");
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><input type="text" class="item-detalle" placeholder="Material o servicio" /></td>
        <td><input type="number" step="0.01" class="item-cantidad" placeholder="0" /></td>
        <td><input type="number" step="0.01" class="item-precio" placeholder="0.00" /></td>
        <td><input type="number" step="0.01" class="item-total" readonly /></td>
        <td style="text-align:center;"><button type="button" class="btn-danger btn-delete-row" title="Eliminar fila">X</button></td>
      `;
      tbody.appendChild(tr);
    }

    function resetForm() {
      const fechaInput = document.getElementById("fecha");
      const today = new Date();
      const offset = today.getTimezoneOffset();
      const localISODate = new Date(today.getTime() - offset * 60000).toISOString().slice(0, 10);
      fechaInput.value = localISODate;

      document.getElementById("cliente").value = "";
      document.getElementById("descripcion").value = "";
      document.getElementById("impuestoPorc").value = 15;

      const tbody = document.getElementById("items-body");
      tbody.innerHTML = "";
      addRow();

      document.getElementById("condiciones").value =
`- Precios sujetos a cambios por variación de materiales.
- Plazo proyectado: 7 días hábiles.
- La compra de materiales debe realizarse con anticipación para asegurar disponibilidad.
- Cotización válida por 15 días.`;

      recalcRowTotals();
    }

    // ================= UTILIDADES PDF =================
    function formatNumber(value) {
      const n = toNumber(value);
      return n.toFixed(2);
    }

    function loadImageAsDataUrl(url) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.crossOrigin = "Anonymous";
        img.onload = function () {
          const canvas = document.createElement("canvas");
          canvas.width = img.width;
          canvas.height = img.height;
          const ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0);
          resolve(canvas.toDataURL("image/png"));
        };
        img.onerror = reject;
        img.src = url;
      });
    }

    // ================= GENERACIÓN DE PDF =================
    async function generatePDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: "mm", format: "letter" });

      const pageWidth = doc.internal.pageSize.getWidth();
      const marginLeft = 18;
      const marginRight = 18;

      const fecha = document.getElementById("fecha").value;
      const cliente = document.getElementById("cliente").value || "Cliente";
      const descripcion = document.getElementById("descripcion").value || "";
      const subtotal = document.getElementById("subtotal").value || "0.00";
      const impuestoPorc = document.getElementById("impuestoPorc").value || "0";
      const impuesto = document.getElementById("impuesto").value || "0.00";
      const total = document.getElementById("total").value || "0.00";
      const condiciones = document.getElementById("condiciones").value || "";

      const tableBody = [];
      const rows = Array.from(document.getElementById("items-body").querySelectorAll("tr"));
      rows.forEach(row => {
        const detalle = row.querySelector(".item-detalle").value || "";
        const cantidad = row.querySelector(".item-cantidad").value || "";
        const precio = row.querySelector(".item-precio").value || "";
        const totalItem = row.querySelector(".item-total").value || "";
        if (detalle || precio || totalItem) {
          tableBody.push([detalle, cantidad, precio, totalItem]);
        }
      });

      if (tableBody.length === 0) {
        alert("Agrega al menos un ítem con cantidad y precio antes de generar el PDF.");
        return;
      }

      let cursorY = 16;

      // Logo opcional
      if (COMPANY_LOGO_URL) {
        try {
          const imgData = await loadImageAsDataUrl(COMPANY_LOGO_URL);
          doc.addImage(imgData, "PNG", marginLeft, cursorY - 4, 26, 14);
        } catch (e) {
          console.warn("No se pudo cargar el logo:", e);
        }
      }

      // Datos empresa
      doc.setFont("helvetica", "bold");
      doc.setFontSize(11);
      doc.text(COMPANY_NAME, marginLeft + 32, cursorY);
      doc.setFont("helvetica", "normal");
      doc.setFontSize(9);
      doc.text(COMPANY_ADDRESS, marginLeft + 32, cursorY + 5);
      doc.text(COMPANY_PHONE, marginLeft + 32, cursorY + 9);
      doc.text(COMPANY_EMAIL, marginLeft + 32, cursorY + 13);

      // Línea separadora
      doc.setDrawColor(220, 220, 220);
      doc.setLineWidth(0.3);
      doc.line(marginLeft, cursorY + 20, pageWidth - marginRight, cursorY + 20);

      cursorY += 26;

      // Título
      doc.setFont("helvetica", "bold");
      doc.setFontSize(16);
      doc.text("COTIZACIÓN", pageWidth / 2, cursorY, { align: "center" });
      cursorY += 8;

      // Fecha y cliente
      doc.setFont("helvetica", "normal");
      doc.setFontSize(10);
      doc.text(`Fecha: ${fecha}`, marginLeft, cursorY);
      cursorY += 5;
      const clienteLines = doc.splitTextToSize(`A nombre de: ${cliente}`, pageWidth - marginLeft - marginRight);
      doc.text(clienteLines, marginLeft, cursorY);
      cursorY += clienteLines.length * 5 + 2;

      // Descripción
      if (descripcion.trim() !== "") {
        const descripcionLines = doc.splitTextToSize(`Descripción del trabajo: ${descripcion}`, pageWidth - marginLeft - marginRight);
        doc.text(descripcionLines, marginLeft, cursorY);
        cursorY += descripcionLines.length * 5 + 2;
      }

      // Tabla
      doc.autoTable({
        startY: cursorY + 2,
        head: [["Ítem / detalle", "Cantidad", "Precio (L.)", "Total ítem (L.)"]],
        body: tableBody,
        theme: "grid",
        styles: { fontSize: 9, cellPadding: 2 },
        headStyles: { fillColor: [37, 99, 235], textColor: 255, halign: "left" },
        columnStyles: {
          0: { cellWidth: 80 },
          1: { halign: "right", cellWidth: 25 },
          2: { halign: "right", cellWidth: 35 },
          3: { halign: "right", cellWidth: 35 }
        },
        margin: { left: marginLeft, right: marginRight }
      });

      let finalY = doc.lastAutoTable.finalY + 4;

      // Bloque de totales en caja
      const boxWidth = 70;
      const boxHeight = 24;
      const boxLeft = pageWidth - marginRight - boxWidth;
      const boxTop = finalY;

      doc.setDrawColor(209, 213, 219);
      doc.setFillColor(248, 250, 252);
      if (doc.roundedRect) {
        doc.roundedRect(boxLeft, boxTop, boxWidth, boxHeight, 2, 2, "DF");
      } else {
        doc.rect(boxLeft, boxTop, boxWidth, boxHeight, "DF");
      }

      doc.setFont("helvetica", "normal");
      doc.setFontSize(9);
      const textX = boxLeft + boxWidth - 2;
      let lineY = boxTop + 6;
      doc.text(`Subtotal: L. ${formatNumber(subtotal)}`, textX, lineY, { align: "right" });
      lineY += 5;
      doc.text(`Impuesto (${impuestoPorc}%): L. ${formatNumber(impuesto)}`, textX, lineY, { align: "right" });
      lineY += 6;
      doc.setFont("helvetica", "bold");
      doc.setFontSize(10);
      doc.text(`Total: L. ${formatNumber(total)}`, textX, lineY, { align: "right" });

      finalY = boxTop + boxHeight + 6;

      // Condiciones
      if (condiciones.trim() !== "") {
        doc.setFont("helvetica", "normal");
        doc.setFontSize(9);
        const condLines = doc.splitTextToSize(`Condiciones y observaciones:\n${condiciones}`, pageWidth - marginLeft - marginRight);
        doc.text(condLines, marginLeft, finalY);
      }

      const cleanCliente = cliente.replace(/[^a-zA-Z0-9-_]/g, "_") || "cliente";
      doc.save(`cotizacion_${cleanCliente}.pdf`);
    }

    // ================= INIT Y EVENTOS =================
    document.addEventListener("DOMContentLoaded", () => {
      resetForm();

      const tbody = document.getElementById("items-body");
      const addRowBtn = document.getElementById("add-row");
      const impuestoPorcInput = document.getElementById("impuestoPorc");
      const resetBtn = document.getElementById("reset-form");
      const downloadBtn = document.getElementById("download-pdf");

      tbody.addEventListener("input", (e) => {
        if (
          e.target.classList.contains("item-cantidad") ||
          e.target.classList.contains("item-precio")
        ) {
          recalcRowTotals();
        }
      });

      tbody.addEventListener("click", (e) => {
        if (e.target.classList.contains("btn-delete-row")) {
          const row = e.target.closest("tr");
          const allRows = tbody.querySelectorAll("tr");
          if (allRows.length > 1) {
            row.remove();
          } else {
            row.querySelectorAll("input").forEach(inp => inp.value = "");
          }
          recalcRowTotals();
        }
      });

      addRowBtn.addEventListener("click", () => {
        addRow();
      });

      impuestoPorcInput.addEventListener("input", () => {
        recalcRowTotals();
      });

      resetBtn.addEventListener("click", () => {
        if (confirm("¿Seguro que deseas limpiar todo el formulario?")) {
          resetForm();
        }
      });

      downloadBtn.addEventListener("click", () => {
        generatePDF();
      });
    });
  </script>
</body>
</html>
