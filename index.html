<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cotizador en Línea</title>

  <!-- jsPDF + AutoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root{
      --bg:#f3f4f6;
      --card:#fff;
      --border:#e5e7eb;
      --text:#111827;
      --muted:#6b7280;
      --primary:#111827;
      --danger:#dc2626;
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh;
      background:var(--bg);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
      color:var(--text);
      display:flex; justify-content:center;
      padding:16px;
    }
    .shell{width:100%; max-width:980px}
    .header{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; margin-bottom:12px;
    }
    .title h1{
      margin:0; font-size:1.35rem; font-weight:800; letter-spacing:.02em;
    }
    .title p{margin:4px 0 0; color:var(--muted); font-size:.9rem}
    .card{
      background:var(--card);
      border-radius:var(--radius);
      border:1px solid rgba(15,23,42,.06);
      box-shadow:0 12px 30px rgba(15,23,42,.08), 0 0 0 1px rgba(15,23,42,.04);
      padding:18px;
    }
    .section{
      margin-top:14px;
      padding-top:14px;
      border-top:1px solid var(--border);
    }
    .section:first-child{margin-top:0;padding-top:0;border-top:0}
    .section-title{
      font-size:.85rem;
      text-transform:uppercase;
      letter-spacing:.08em;
      color:var(--muted);
      margin-bottom:10px;
      font-weight:800;
    }
    .row{display:flex; flex-wrap:wrap; gap:10px}
    .field{flex:1; min-width:220px; display:flex; flex-direction:column; gap:6px}
    label{font-size:.8rem; font-weight:700; color:var(--muted)}
    input, textarea{
      border:1px solid var(--border);
      background:#f9fafb;
      border-radius:12px;
      padding:10px 12px;
      font-size:.95rem;
      outline:none;
      transition:.15s;
    }
    input:focus, textarea:focus{
      background:#fff;
      border-color:#9ca3af;
      box-shadow:0 0 0 3px rgba(17,24,39,.08);
    }
    textarea{resize:vertical; min-height:72px}

    /* Items table */
    .table-wrap{
      border:1px solid var(--border);
      border-radius:14px;
      overflow:hidden;
      background:#fff;
    }
    table{width:100%; border-collapse:collapse; font-size:.92rem}
    thead{background:#f3f4f6}
    th,td{padding:10px; border-bottom:1px solid var(--border); vertical-align:top}
    th{
      font-size:.75rem;
      text-transform:uppercase;
      letter-spacing:.08em;
      color:var(--muted);
      text-align:left;
      font-weight:900;
    }
    tbody tr:last-child td{border-bottom:0}
    td input{
      width:100%;
      padding:8px 10px;
      border-radius:10px;
      background:#f9fafb;
    }
    td input[readonly]{background:#eef2ff; font-weight:800}
    .item-stack{display:flex; flex-direction:column; gap:8px}
    .hint{
      margin-top:8px;
      font-size:.84rem;
      color:var(--muted);
      line-height:1.25;
    }

    .actions{
      display:flex; flex-wrap:wrap; gap:10px;
      justify-content:space-between; align-items:center;
      margin-top:10px;
    }
    button{
      border:0; border-radius:999px;
      padding:10px 14px;
      font-weight:900;
      cursor:pointer;
      transition:.12s;
    }
    .btn-secondary{background:#e5e7eb; color:#111827}
    .btn-secondary:hover{background:#d1d5db}
    .btn-primary{background:#111827; color:#fff}
    .btn-primary:hover{background:#0b1220}
    .btn-danger{
      background:var(--danger); color:#fff;
      padding:8px 10px; border-radius:999px; font-weight:900;
    }

    .totals{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:10px;
    }
    @media(min-width:820px){
      .totals{grid-template-columns:repeat(4,minmax(0,1fr))}
    }

    /* Mobile table -> card */
    @media (max-width: 640px){
      .header{flex-direction:column; align-items:flex-start}
      .field{min-width:100%}
      table, thead, tbody, tr, td{display:block; width:100%}
      thead{display:none}
      tbody tr{
        border:1px solid var(--border);
        border-radius:14px;
        margin:10px 0;
        padding:10px;
        box-shadow:0 1px 2px rgba(15,23,42,.05);
      }
      td{border-bottom:0; padding:8px 0}
      td::before{
        content:attr(data-label);
        display:block;
        font-size:.75rem;
        font-weight:900;
        color:var(--muted);
        letter-spacing:.06em;
        text-transform:uppercase;
        margin-bottom:6px;
      }
      td:last-child::before{content:""}
    }
  </style>
</head>

<body>
  <div class="shell">
    <div class="header">
      <div class="title">
        <h1>Cotizador en línea</h1>
        <p>Genera cotizaciones profesionales en PDF (logo incrustado para impresión y WhatsApp).</p>
      </div>
    </div>

    <main class="card">
      <div class="section">
        <div class="section-title">Datos generales</div>
        <div class="row">
          <div class="field">
            <label for="fecha">Fecha</label>
            <input type="date" id="fecha" />
          </div>
          <div class="field">
            <label for="cliente">A nombre de</label>
            <input type="text" id="cliente" placeholder="Nombre del cliente o empresa" />
          </div>
        </div>

        <div class="row" style="margin-top:10px;">
          <div class="field">
            <label for="descripcion">Descripción del trabajo</label>
            <textarea id="descripcion" placeholder="Ej.: Fabricación e instalación, reparación, pintura, etc."></textarea>
          </div>
        </div>
      </div>

      <div class="section">
        <div class="section-title">Identidad del PDF</div>
        <div class="row">
          <div class="field">
            <label for="logoFile">Logo (aquí va el logo que se verá en la esquina superior izquierda del PDF).</label>
            <input type="file" id="logoFile" accept="image/png,image/jpeg,image/webp" />
          </div>
          <div class="field">
            <label for="pdfName">Nombre del archivo PDF (opcional)</label>
            <input type="text" id="pdfName" placeholder="Ej.: cotizacion_cliente_enero" />
          </div>
        </div>
      </div>

      <div class="section">
        <div class="section-title">Ítems</div>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Ítem / detalle</th>
                <th style="width:120px;">Cantidad</th>
                <th style="width:170px;">Precio unitario (L.)</th>
                <th style="width:170px;">Total ítem (L.)</th>
                <th style="width:80px; text-align:center;"> </th>
              </tr>
            </thead>
            <tbody id="items-body">
              <tr>
                <td data-label="Ítem / detalle">
                  <div class="item-stack">
                    <input type="text" class="item-detalle" placeholder="Ej.: Mano de obra, madera, insumos..." />
                    <input type="text" class="item-desc" placeholder="Descripción opcional (medidas, color, acabado). Si se deja vacía, no afecta el PDF." />
                  </div>
                </td>
                <td data-label="Cantidad"><input type="number" step="0.01" class="item-cantidad" placeholder="0" /></td>
                <td data-label="Precio unitario (L.)"><input type="number" step="0.01" class="item-precio" placeholder="0.00" /></td>
                <td data-label="Total ítem (L.)"><input type="number" step="0.01" class="item-total" readonly /></td>
                <td data-label="" style="text-align:center;">
                  <button type="button" class="btn-danger btn-delete-row" title="Eliminar fila">X</button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="actions">
          <button type="button" class="btn-secondary" id="add-row">Agregar ítem</button>
          <div class="hint" style="margin:0;">
            La “descripción opcional” se imprime debajo del ítem solo si la llenas.
          </div>
        </div>
      </div>

      <div class="section">
        <div class="section-title">Totales</div>
        <div class="totals">
          <div class="field">
            <label for="subtotal">Subtotal (L.)</label>
            <input type="number" id="subtotal" readonly />
          </div>
          <div class="field">
            <label for="impuestoPorc">Impuesto (%)</label>
            <input type="number" id="impuestoPorc" step="0.01" value="15" />
          </div>
          <div class="field">
            <label for="impuesto">Impuesto (L.)</label>
            <input type="number" id="impuesto" readonly />
          </div>
          <div class="field">
            <label for="total">Total (L.)</label>
            <input type="number" id="total" readonly />
          </div>
        </div>
      </div>

      <div class="section">
        <div class="section-title">Condiciones y observaciones</div>
        <textarea id="condiciones" style="min-height:90px;"></textarea>
        <div class="hint">
          Sugerencia: incluye forma de pago, vigencia, tiempos y alcances (qué incluye y qué no incluye).
        </div>
      </div>

      <div class="section">
        <div class="actions" style="justify-content:flex-end;">
          <button type="button" class="btn-secondary" id="reset-form">Limpiar formulario</button>
          <button type="button" class="btn-primary" id="download-pdf">Descargar PDF profesional</button>
        </div>
      </div>
    </main>
  </div>

  <script>
    // ================= CONFIGURACIÓN EMPRESA =================
    const COMPANY = {
      name: "Carpinteros HN",
      address: "Servicios en línea",
      phone: "Tel: 96696605",
      email: "Correo: jorgeruedabeta@gmail.com",
    };

    // Logo incrustado como DataURL (garantiza que salga en el PDF)
    let LOGO_DATA_URL = null;

    // Fallback opcional: si estás en servidor, intenta cargar ./img/logo.png
    async function tryLoadFallbackLogo() {
      try {
        const res = await fetch("./img/logo.png", { cache: "no-store" });
        if (!res.ok) return;
        const blob = await res.blob();
        LOGO_DATA_URL = await blobToDataURL(blob);
      } catch (_) { /* ignore */ }
    }

    function blobToDataURL(blob) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(blob);
      });
    }

    function toNumber(value) {
      if (typeof value !== "string") value = String(value || "");
      value = value.replace(",", ".");
      const n = parseFloat(value);
      return isNaN(n) ? 0 : n;
    }

    function money(n) {
      return toNumber(n).toFixed(2);
    }

    function recalc() {
      const tbody = document.getElementById("items-body");
      const rows = Array.from(tbody.querySelectorAll("tr"));
      let subtotal = 0;

      rows.forEach(row => {
        const qty = toNumber(row.querySelector(".item-cantidad")?.value);
        const price = toNumber(row.querySelector(".item-precio")?.value);
        const total = qty * price;

        row.querySelector(".item-total").value = total ? total.toFixed(2) : "";
        subtotal += total;
      });

      document.getElementById("subtotal").value = subtotal.toFixed(2);

      const taxPct = toNumber(document.getElementById("impuestoPorc").value);
      const tax = subtotal * (taxPct / 100);
      document.getElementById("impuesto").value = tax.toFixed(2);
      document.getElementById("total").value = (subtotal + tax).toFixed(2);
    }

    function addRow() {
      const tbody = document.getElementById("items-body");
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td data-label="Ítem / detalle">
          <div class="item-stack">
            <input type="text" class="item-detalle" placeholder="Material o servicio" />
            <input type="text" class="item-desc" placeholder="Descripción opcional (medidas, color, acabado). Si se deja vacía, no afecta el PDF." />
          </div>
        </td>
        <td data-label="Cantidad"><input type="number" step="0.01" class="item-cantidad" placeholder="0" /></td>
        <td data-label="Precio unitario (L.)"><input type="number" step="0.01" class="item-precio" placeholder="0.00" /></td>
        <td data-label="Total ítem (L.)"><input type="number" step="0.01" class="item-total" readonly /></td>
        <td data-label="" style="text-align:center;">
          <button type="button" class="btn-danger btn-delete-row" title="Eliminar fila">X</button>
        </td>
      `;
      tbody.appendChild(tr);
    }

    function resetForm() {
      const fechaInput = document.getElementById("fecha");
      const today = new Date();
      const offset = today.getTimezoneOffset();
      fechaInput.value = new Date(today.getTime() - offset * 60000).toISOString().slice(0, 10);

      document.getElementById("cliente").value = "";
      document.getElementById("descripcion").value = "";
      document.getElementById("pdfName").value = "";
      document.getElementById("impuestoPorc").value = 15;

      const tbody = document.getElementById("items-body");
      tbody.innerHTML = "";
      addRow();

      document.getElementById("condiciones").value =
`- Precios sujetos a cambios por variación de materiales.
- Plazo estimado: 7 días hábiles.
- Materiales se compran con anticipo para asegurar disponibilidad.
- Cotización válida por 15 días.`;

      recalc();
    }

    function collectTableBody() {
      const rows = Array.from(document.querySelectorAll("#items-body tr"));
      const body = [];

      rows.forEach(row => {
        const detalle = (row.querySelector(".item-detalle")?.value || "").trim();
        const desc = (row.querySelector(".item-desc")?.value || "").trim();
        const cantidad = (row.querySelector(".item-cantidad")?.value || "").trim();
        const precio = (row.querySelector(".item-precio")?.value || "").trim();
        const total = (row.querySelector(".item-total")?.value || "").trim();

        const cell0 = { content: detalle || "-", __desc: desc };

        if (detalle || desc || cantidad || precio) {
          body.push([cell0, cantidad, precio, total]);
        }
      });

      return body;
    }

    // ================= PDF =================
    async function generatePDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: "mm", format: "letter" });

      const pageW = doc.internal.pageSize.getWidth();
      const pageH = doc.internal.pageSize.getHeight();
      const marginL = 16;
      const marginR = 16;
      const contentW = pageW - marginL - marginR;

      const fecha = document.getElementById("fecha").value || "";
      const cliente = (document.getElementById("cliente").value || "Cliente").trim();
      const descripcion = (document.getElementById("descripcion").value || "").trim();
      const impuestoPorc = (document.getElementById("impuestoPorc").value || "0").trim();
      const subtotal = document.getElementById("subtotal").value || "0.00";
      const impuesto = document.getElementById("impuesto").value || "0.00";
      const total = document.getElementById("total").value || "0.00";
      const condiciones = (document.getElementById("condiciones").value || "").trim();
      const pdfNameRaw = document.getElementById("pdfName").value.trim();

      const body = collectTableBody();
      if (body.length === 0) {
        alert("Agrega al menos un ítem antes de generar el PDF.");
        return;
      }

      if (!LOGO_DATA_URL) {
        await tryLoadFallbackLogo();
      }

      const COL = {
        ink: [17, 24, 39],
        muted: [107, 114, 128],
        line: [210, 210, 210],
        headerFill: [245, 246, 248],
        zebra: [250, 250, 250],
      };

      doc.setDrawColor(...COL.line);

      // Header
      const logoSize = 18;
      const logoX = marginL;
      const logoY = 14;

      if (LOGO_DATA_URL) {
        doc.addImage(LOGO_DATA_URL, "PNG", logoX, logoY, logoSize, logoSize);
      }

      const companyX = LOGO_DATA_URL ? (logoX + logoSize + 8) : marginL;
      let y = 18;

      doc.setTextColor(...COL.ink);
      doc.setFont("helvetica", "bold");
      doc.setFontSize(12);
      doc.text(COMPANY.name, companyX, y);

      doc.setFont("helvetica", "normal");
      doc.setFontSize(9.3);
      doc.setTextColor(...COL.muted);
      doc.text(COMPANY.address, companyX, y + 5);
      doc.text(COMPANY.phone, companyX, y + 9);
      doc.text(COMPANY.email, companyX, y + 13);

      // Meta box
      const metaW = 68;
      const metaH = 24;
      const metaX = pageW - marginR - metaW;
      const metaY = 14;

      doc.setDrawColor(...COL.line);
      doc.setLineWidth(0.35);
      doc.rect(metaX, metaY, metaW, metaH);

      const quoteNo = `CTZ-${new Date().getFullYear()}-${String(Math.floor(Math.random() * 9000) + 1000)}`;

      doc.setTextColor(...COL.ink);
      doc.setFont("helvetica", "bold");
      doc.setFontSize(10.5);
      doc.text("Cotización", metaX + metaW - 4, metaY + 7, { align: "right" });

      doc.setFont("helvetica", "normal");
      doc.setFontSize(9);
      doc.setTextColor(...COL.muted);
      doc.text(`No.: ${quoteNo}`, metaX + 4, metaY + 13);
      doc.text(`Fecha: ${fecha || "-"}`, metaX + 4, metaY + 18);

      // Cliente box (dinámica)
      y = 46;

      doc.setTextColor(...COL.ink);
      doc.setFont("helvetica", "bold");
      doc.setFontSize(10.5);
      doc.text("Cliente", marginL, y);

      const clientY = y + 4;

      const boxPadX = 4;
      const innerW = contentW - (boxPadX * 2);

      doc.setFont("helvetica", "normal");
      doc.setFontSize(10);
      doc.setTextColor(...COL.ink);
      const clientLines = doc.splitTextToSize(cliente, innerW);

      let descLines = [];
      if (descripcion) {
        doc.setFontSize(9.3);
        doc.setTextColor(...COL.muted);
        descLines = doc.splitTextToSize(descripcion, innerW);
      }

      const topPadY = 7;
      const bottomPadY = 5;
      const clientLineGap = 4.2;
      const descLineGap = 3.8;
      const spacer = descLines.length ? 3 : 0;

      const clienteH = clientLines.length * clientLineGap;
      const descH = descLines.length * descLineGap;

      let clientH = topPadY + clienteH + spacer + descH + bottomPadY;

      const reserveBelow = 18;
      if (clientY + clientH + reserveBelow > pageH) {
        doc.addPage();
        y = 18;

        doc.setTextColor(...COL.ink);
        doc.setFont("helvetica", "bold");
        doc.setFontSize(10.5);
        doc.text("Cliente", marginL, y);

        const newClientY = y + 4;

        clientH = topPadY + clienteH + spacer + descH + bottomPadY;

        doc.setLineWidth(0.35);
        doc.setDrawColor(...COL.line);
        doc.rect(marginL, newClientY, contentW, clientH);

        let textY = newClientY + topPadY;
        doc.setFont("helvetica", "normal");
        doc.setFontSize(10);
        doc.setTextColor(...COL.ink);
        doc.text(clientLines, marginL + boxPadX, textY);

        if (descLines.length) {
          textY += (clientLines.length * clientLineGap) + spacer;
          doc.setFontSize(9.3);
          doc.setTextColor(...COL.muted);
          doc.text(descLines, marginL + boxPadX, textY);
        }

        y = newClientY + clientH + 10;
      } else {
        doc.setLineWidth(0.35);
        doc.setDrawColor(...COL.line);
        doc.rect(marginL, clientY, contentW, clientH);

        let textY = clientY + topPadY;
        doc.setFont("helvetica", "normal");
        doc.setFontSize(10);
        doc.setTextColor(...COL.ink);
        doc.text(clientLines, marginL + boxPadX, textY);

        if (descLines.length) {
          textY += (clientLines.length * clientLineGap) + spacer;
          doc.setFontSize(9.3);
          doc.setTextColor(...COL.muted);
          doc.text(descLines, marginL + boxPadX, textY);
        }

        y = clientY + clientH + 10;
      }

      // ===================== TABLA DE ÍTEMS (DESCRIPCIÓN FIX + ANCHO SEGURO) =====================
      doc.autoTable({
        startY: y,
        head: [["Ítem / detalle", "Cant.", "Precio (L.)", "Total (L.)"]],
        body,
        theme: "grid",
        margin: { left: marginL, right: marginR },
        styles: {
          font: "helvetica",
          fontSize: 9.5,
          cellPadding: { top: 2.3, right: 2.3, bottom: 2.3, left: 2.3 },
          lineColor: COL.line,
          lineWidth: 0.25,
          textColor: COL.ink,
          overflow: "linebreak",
          valign: "top",
        },
        headStyles: {
          fillColor: COL.headerFill,
          textColor: COL.ink,
          fontStyle: "bold",
          lineColor: COL.line,
          lineWidth: 0.25,
        },
        alternateRowStyles: { fillColor: COL.zebra },
        columnStyles: {
          0: { cellWidth: 92 },
          1: { cellWidth: 18, halign: "right" },
          2: { cellWidth: 34, halign: "right" },
          3: { cellWidth: 34, halign: "right" },
        },

        didParseCell: function (data) {
          if (data.section === "body" && data.column.index === 0) {
            const raw = data.cell.raw || {};
            const desc = String(raw.__desc || "").trim();
            data.cell.__desc = desc;
            if (!desc) return;

            const doc = data.doc;

            const pad = 2.3;
            const cellW = Number(data.cell.width) || Number(data.column.width) || 92;
            const safeMaxW = Math.max(40, cellW - (pad * 2)); // evita wrap letra-por-letra

            const prevSize = doc.internal.getFontSize();
            doc.setFont("helvetica", "normal");
            doc.setFontSize(8.2);

            const descLines = doc.splitTextToSize(desc, safeMaxW);
            data.cell.__descLines = descLines;

            const lh = (8.2 * 1.20) / doc.internal.scaleFactor;
            const extraH = (descLines.length * lh) + 2.0;

            data.cell.styles.minCellHeight = (data.cell.styles.minCellHeight || 0) + extraH;

            doc.setFontSize(prevSize);
          }
        },

        didDrawCell: function (data) {
          if (data.section === "body" && data.column.index === 0) {
            const desc = (data.cell.__desc || "").trim();
            if (!desc) return;

            const doc = data.doc;

            const pad = 2.3;
            const x = data.cell.x + pad;

            const mainLines = Array.isArray(data.cell.text) ? data.cell.text : [String(data.cell.text || "")];
            const mainFontSize = data.cell.styles.fontSize || 9.5;
            const mainLh = (mainFontSize * 1.20) / doc.internal.scaleFactor;

            const mainStartY = data.cell.textPos?.y ?? (data.cell.y + pad + 4);
            let yAfterMain = mainStartY + (mainLines.length * mainLh) + 1.6;

            const cellW = Number(data.cell.width) || Number(data.column.width) || 92;
            const safeMaxW = Math.max(40, cellW - (pad * 2));

            const prevSize = doc.internal.getFontSize();
            const prevColor = doc.getTextColor();

            doc.setFont("helvetica", "normal");
            doc.setFontSize(8.2);
            doc.setTextColor(107, 114, 128);

            const lines = data.cell.__descLines || doc.splitTextToSize(desc, safeMaxW);
            doc.text(lines, x, yAfterMain);

            doc.setFontSize(prevSize);
            doc.setTextColor(prevColor);
          }
        }
      });

      let afterTableY = doc.lastAutoTable.finalY + 8;

      // Totales
      const totalsW = 78;
      const totalsH = 30;
      const totalsX = pageW - marginR - totalsW;
      const totalsY = afterTableY;

      doc.setDrawColor(...COL.line);
      doc.setLineWidth(0.35);
      doc.rect(totalsX, totalsY, totalsW, totalsH);

      const rightX = totalsX + totalsW - 5;

      doc.setFont("helvetica", "normal");
      doc.setFontSize(9.5);
      doc.setTextColor(...COL.muted);
      doc.text("Subtotal", totalsX + 5, totalsY + 8);
      doc.text("Impuesto", totalsX + 5, totalsY + 15);

      doc.setTextColor(...COL.ink);
      doc.text(`L. ${money(subtotal)}`, rightX, totalsY + 8, { align: "right" });
      doc.text(`L. ${money(impuesto)} (${impuestoPorc}%)`, rightX, totalsY + 15, { align: "right" });

      doc.setDrawColor(...COL.line);
      doc.setLineWidth(0.35);
      doc.line(totalsX + 5, totalsY + 20, totalsX + totalsW - 5, totalsY + 20);

      doc.setFont("helvetica", "bold");
      doc.setFontSize(11.5);
      doc.text("Total", totalsX + 5, totalsY + 27);
      doc.text(`L. ${money(total)}`, rightX, totalsY + 27, { align: "right" });

      afterTableY = totalsY + totalsH + 10;

      // Condiciones
      if (condiciones) {
        if (afterTableY > pageH - 60) {
          doc.addPage();
          afterTableY = 18;
        }

        doc.setTextColor(...COL.ink);
        doc.setFont("helvetica", "bold");
        doc.setFontSize(10.5);
        doc.text("Condiciones y observaciones", marginL, afterTableY);

        doc.setFont("helvetica", "normal");
        doc.setFontSize(9.3);
        doc.setTextColor(...COL.muted);
        const condLines = doc.splitTextToSize(condiciones, contentW);
        doc.text(condLines, marginL, afterTableY + 6);
      }

      // Footer + páginas
      const pageCount = doc.getNumberOfPages();
      for (let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.setFont("helvetica", "normal");
        doc.setFontSize(8);
        doc.setTextColor(...COL.muted);
        doc.text(`${COMPANY.name} · ${COMPANY.phone}`, pageW / 2, pageH - 8, { align: "center" });
        doc.text(`Página ${i} de ${pageCount}`, pageW - marginR, pageH - 8, { align: "right" });
      }

      let baseName = pdfNameRaw || `cotizacion_${cliente}`;
      baseName = baseName.replace(/[^a-zA-Z0-9-_]/g, "_") || "cotizacion";
      doc.save(`${baseName}.pdf`);
    }

    // ================= INIT Y EVENTOS =================
    document.addEventListener("DOMContentLoaded", async () => {
      resetForm();
      await tryLoadFallbackLogo();

      document.getElementById("logoFile").addEventListener("change", async (e) => {
        const file = e.target.files?.[0];
        if (!file) return;
        LOGO_DATA_URL = await blobToDataURL(file);
      });

      const tbody = document.getElementById("items-body");

      tbody.addEventListener("input", (e) => {
        if (e.target.classList.contains("item-cantidad") || e.target.classList.contains("item-precio")) {
          recalc();
        }
      });

      tbody.addEventListener("click", (e) => {
        if (e.target.classList.contains("btn-delete-row")) {
          const row = e.target.closest("tr");
          const all = tbody.querySelectorAll("tr");
          if (all.length > 1) row.remove();
          else row.querySelectorAll("input").forEach(inp => inp.value = "");
          recalc();
        }
      });

      document.getElementById("add-row").addEventListener("click", () => addRow());
      document.getElementById("impuestoPorc").addEventListener("input", () => recalc());

      document.getElementById("reset-form").addEventListener("click", () => {
        if (confirm("¿Seguro que deseas limpiar todo el formulario?")) resetForm();
      });

      document.getElementById("download-pdf").addEventListener("click", () => generatePDF());
    });
  </script>
</body>
</html>
